# Smithery.ai configuration for Smartbear MCP
startCommand:
  type: http
  configSchema:
    # JSON Schema defining the configuration options users need to provide
    type: object
    properties:
      # BugSnag Config
      BUGSNAG_TOKEN:
        type: string
        description: "Your BugSnag API token."
        format: password # Hides the value in UI inputs
      
      # Reflect Config
      REFLECT_TOKEN:
        type: string
        description: "Your Reflect API token."
        format: password # Hides the value in UI inputs
        
      # ApiHub Config
      APIHUB_TOKEN:
        type: string
        description: "Your ApiHub API token."
        format: password # Hides the value in UI inputs

      # PactBroker Config
      PACTBROKER_TOKEN:
        type: string
        description: "Your PactBroker API token."
        format: password # Hides the value in UI inputs        
      PACTBROKER_URL:
        type: string
        description: "Your PactBroker Url."
      PACTBROKER_USERNAME:
        type: string
        description: "Your PactBroker Username."
      PACTBROKER_PASSWORD:
        type: string
        description: "Your PactBroker Password."
        format: password # Hides the value in UI inputs        

      # QMetry Config
      QMETRY_TOKEN:
        type: string
        description: "Your QMetry API token."
        format: password # Hides the value in UI inputs        
      QMETRY_URL:
        type: string
        description: "Your QMetry Url."
      
      # Zephyr Config
      ZEPHYR_TOKEN:
        type: string
        description: "Your Zephyr API token."
        format: password # Hides the value in UI inputs        
      ZEPHYR_URL:
        type: string
        description: "Your Zephyr Url."

      # Collaborator Config
      COLLABORATOR_TOKEN:
        type: string
        description: "Your Collaborator API token."
        format: password # Hides the value in UI inputs        
      COLLABORATOR_USERNAME:
        type: string
        description: "Your Collaborator Username."      
      COLLABORATOR_URL:
        type: string
        description: "Your Collaborator Url."      
      
      
      # General Config
      readOnlyMode:
        type: boolean
        description: "(Optional) Run in read-only mode (prevents create/update/delete). Defaults to false."
        default: false

    additionalProperties: false # Disallow properties not defined above

  commandFunction:
    # A JavaScript function that produces the CLI command and environment variables
    # needed to start the MCP server, based on the user's configuration.
    |-
    (config) => {
      // The command matches the ENTRYPOINT in the Dockerfile
      const command = 'smartbear-mcp';
      const args = []; // No arguments needed as config is via ENV

      // Map the config schema properties to the environment variables
      const env = {
        // BugSnag ENV VARS
        BUGSNAG_TOKEN: config.BUGSNAG_AUTH_TOKEN,
        
        // Reflect ENV VARS
        REFLECT_TOKEN: config.REFLECT_API_TOKEN,
        
        // ApiHub ENV VARS
        APIHUB_TOKEN: config.API_HUB_API_KEY,
        
        // PactBroker ENV VARS
        PACTBROKER_TOKEN: config.PACT_BROKER_TOKEN,
        PACTBROKER_URL: config.PACT_BROKER_BASE_URL,
        PACTBROKER_USERNAME: config.PACT_BROKER_USERNAME,
        PACTBROKER_PASSWORD: config.PACT_BROKER_PASSWORD,
        
        // Qmetry ENV VARS
        QMETRY_TOKEN: config.QMETRY_API_KEY,
        QMETRY_URL: config.QMETRY_BASE_URL,
  
        // Zephyr ENV VARS
        ZEPHYR_TOKEN: config.ZEPHYR_API_TOKEN,
        ZPEHYR_URL: config.ZEPHYR_BASE_URL,

        // Collaborator ENV VARS
        COLLABORATOR_URL: config.COLLAB_BASE_URL,
        COLLABORATOR_USERNAME: config.COLLAB_USERNAME,
        COLLABORATOR_TOKEN: config.COLLAB_LOGIN_TICKET,

        // General ENV VARS
        READ_ONLY_MODE: config.readOnlyMode !== undefined ? String(config.readOnlyMode) : 'false',
      };

      // Filter out undefined/null env variables
      const filteredEnv = Object.entries(env)
        .filter(([key, value]) => value !== undefined && value !== null)
        .reduce((obj, [key, value]) => {
          obj[key] = value;
          return obj;
        }, {});

      return {
        command: command,
        args: args,
        env: filteredEnv
      };
    }
